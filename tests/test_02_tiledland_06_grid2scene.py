import sys
sys.path.insert( 1, __file__.split('tests')[0] )

from src import tiledland as tll

# ------------------------------------------------------------------------ #
#         T E S T   T I L E D L A N D - C O M P O N E N T
# ------------------------------------------------------------------------ #

def test_g2s_makeRectangles_small():
    grid= tll.Grid()
    grid.initialize([
        [1, 1, 0,  0, 0],
        [1, 1, 0,  0, 0],
        [0, 0, 0,  0, 0],

        [0, 0, 0,  0, 0],
        [0, 0, 0,  0, 0],
        [0, 0, 0,  0, 0]
    ])

    assert grid.resolution() == 0.1 # dm
    assert grid.bottomleft().asTuple() == (0.0, 0.0)
    shapes= grid.makeRectangles(0)

    assert len(shapes) == 2
    
    print( shapes[0].round(2).asZipped() )
    assert shapes[0].round(2).asZipped() == [
        (0.01, 0.01), (0.01, 0.39), (0.49, 0.39), (0.49, 0.01)
    ]

    print( shapes[1].round(2).asZipped() )
    assert shapes[1].round(2).asZipped() == [
        (0.21, 0.41), (0.21, 0.59), (0.49, 0.59), (0.49, 0.41)
    ]

    # Scene Construction :
    scene= tll.Scene( epsilon=0.06 )
    shapes= grid.makeRectangles(0)
    i= 0
    for s in shapes :
        i+= 1
        assert scene.createTile(s, 0) == i
        scene.tile(i).position().round(2)
        scene.tile(i).shape().round(2)
    assert scene.size() == i
    assert i == 2

    print( scene.asPod() )
    assert "\n"+ str(scene.asPod()) +"\n" =="""
Scene: [0.06]
- Tile: [1, 0] [0.25, 0.2]
  - Convex: [-0.24, -0.19, -0.24, 0.19, 0.24, 0.19, 0.24, -0.19]
- Tile: [2, 0] [0.35, 0.5]
  - Convex: [-0.14, -0.09, -0.14, 0.09, 0.14, 0.09, 0.14, -0.09]
"""

    shapes= grid.makeRectangles(1)
    for s in shapes :
        i+= 1
        assert scene.createTile(s, 1) == i
        scene.tile(i).position().round(2)
        scene.tile(i).shape().round(2)
    assert scene.size() == 3

    print( '-'*10 )
    print( scene.asPod() )

    assert "\n"+ str(scene.asPod()) +"\n" =="""
Scene: [0.06]
- Tile: [1, 0] [0.25, 0.2]
  - Convex: [-0.24, -0.19, -0.24, 0.19, 0.24, 0.19, 0.24, -0.19]
- Tile: [2, 0] [0.35, 0.5]
  - Convex: [-0.14, -0.09, -0.14, 0.09, 0.14, 0.09, 0.14, -0.09]
- Tile: [3, 1] [0.1, 0.5]
  - Convex: [-0.09, -0.09, -0.09, 0.09, 0.09, 0.09, 0.09, -0.09]
"""

    scene.connectAllClose( grid.resolution() )

    print( '-'*10 )
    print( scene.asPod() )

    assert "\n"+ str(scene.asPod()) +"\n" =="""
Scene: [0.06]
- Tile: [1, 0, 2, 3] [0.25, 0.2]
  - Convex: [-0.24, -0.19, -0.24, 0.19, 0.24, 0.19, 0.24, -0.19]
- Tile: [2, 0, 1, 3] [0.35, 0.5]
  - Convex: [-0.14, -0.09, -0.14, 0.09, 0.14, 0.09, 0.14, -0.09]
- Tile: [3, 1, 1, 2] [0.1, 0.5]
  - Convex: [-0.09, -0.09, -0.09, 0.09, 0.09, 0.09, 0.09, -0.09]
"""

    # Scene Construction, in short:
    scene= tll.Scene().fromGridRectangles(grid)
    scene._epsilon= round( scene._epsilon, 6 )

    for t in scene.tiles() :
        t.position().round(2)
        t.shape().round(2)
    
    print( '-'*10 )
    print( scene.asPod() )

    tll.artist.drawScene(scene)

    assert True or "\n"+ str(scene.asPod()) +"\n" =="""
Scene: [0.06]
- Tile: [1, 0, 2, 3] [0.25, 0.2]
  - Convex: [-0.24, -0.19, -0.24, 0.19, 0.24, 0.19, 0.24, -0.19]
- Tile: [2, 0, 1, 3] [0.35, 0.5]
  - Convex: [-0.14, -0.09, -0.14, 0.09, 0.14, 0.09, 0.14, -0.09]
- Tile: [3, 1, 1, 2] [0.1, 0.5]
  - Convex: [-0.09, -0.09, -0.09, 0.09, 0.09, 0.09, 0.09, -0.09]
"""

def test_g2s_makeRectangles_medium():
    grid= tll.Grid()
    grid.initialize([
        [1, 1, 1,  0, 0, 0,  0, 0, 0],
        [1, 1, 0,  0, 0, 0,  0, 0, 0],
        [1, 0, 0,  0, 0, 0,  0, 0, 0],

        [0, 0, 0,  0, 1, 1,  0, 0, 0],
        [0, 0, 0,  0, 1, 1,  0, 0, 0],
        [0, 0, 0,  0, 1, 1,  0, 0, 0],

        [0, 0, 0,  0, 0, 0,  0, 0, 0],
        [0, 0, 0,  0, 0, 0,  0, 0, 0],
        [0, 0, 0,  0, 0, 0,  0, 0, 0]
    ])

    shapes= grid.makeRectangles(0)

    assert len(shapes) == 6
    referes= [
        [(0.01, 0.01), (0.01, 0.59), (0.39, 0.59), (0.39, 0.01)],
        [(0.41, 0.01), (0.41, 0.29), (0.89, 0.29), (0.89, 0.01)],
        [(0.61, 0.31), (0.61, 0.89), (0.89, 0.89), (0.89, 0.31)],
        [(0.11, 0.61), (0.11, 0.69), (0.59, 0.69), (0.59, 0.61)],
        [(0.21, 0.71), (0.21, 0.79), (0.59, 0.79), (0.59, 0.71)],
        [(0.31, 0.81), (0.31, 0.89), (0.59, 0.89), (0.59, 0.81)]
    ]

    print( '-'*10 )
    for shape, ref  in zip( shapes, referes ) :
        print( shape.round(2).asZipped() )
        assert shape.asZipped() ==  ref
    
    shapes= grid.makeRectangles(1)

    assert len(shapes) == 4
    referes= [
        [(0.41, 0.31), (0.41, 0.59), (0.59, 0.59), (0.59, 0.31)],
        [(0.01, 0.61), (0.01, 0.89), (0.09, 0.89), (0.09, 0.61)],
        [(0.11, 0.71), (0.11, 0.89), (0.19, 0.89), (0.19, 0.71)],
        [(0.21, 0.81), (0.21, 0.89), (0.29, 0.89), (0.29, 0.81)]
    ]

    print( '-'*10 )
    for shape, ref  in zip( shapes, referes ) :
        print( shape.round(2).asZipped() )
        assert True or shape.asZipped() ==  ref
    
    # Scene from grid:
    scene= tll.Scene().fromGridRectangles(grid)

    for t in scene.tiles() :
        t.position().round(2)
        t.shape().round(2)
    
    print( '-'*10 )
    print( scene.asPod() )

    tll.artist.drawScene(scene)

    assert "\n"+ str(scene.asPod()) +"\n" == """
Scene: [0.04000000000000001]
- Tile: [1, 0, 2, 4, 5, 6] [0.2, 0.3]
  - Convex: [-0.19, -0.29, -0.19, 0.29, 0.19, 0.29, 0.19, -0.29]
- Tile: [2, 0, 1, 3, 5] [0.65, 0.15]
  - Convex: [-0.24, -0.14, -0.24, 0.14, 0.24, 0.14, 0.24, -0.14]
- Tile: [3, 0, 2, 4, 5] [0.75, 0.6]
  - Convex: [-0.14, -0.29, -0.14, 0.29, 0.14, 0.29, 0.14, -0.29]
- Tile: [4, 0, 1, 3, 5, 6] [0.35, 0.75]
  - Convex: [-0.24, -0.14, -0.04, 0.14, 0.24, 0.14, 0.24, -0.14]
- Tile: [5, 1, 1, 2, 3, 4] [0.5, 0.45]
  - Convex: [-0.09, -0.14, -0.09, 0.14, 0.09, 0.14, 0.09, -0.14]
- Tile: [6, 1, 1, 4] [0.15, 0.75]
  - Convex: [-0.14, -0.14, -0.14, 0.14, 0.14, 0.14, 0.14, 0.06]
"""

def test_g2s_makeRectangles_medium_limit():
    scene= tll.Scene()
    grid= tll.Grid()
    grid.initialize([
        [1, 1, 1,  0, 0, 0,  0, 0, 0],
        [1, 1, 0,  0, 0, 0,  0, 0, 0],
        [1, 0, 0,  0, 0, 0,  0, 0, 0],

        [0, 0, 0,  0, 1, 1,  0, 0, 0],
        [0, 0, 0,  0, 1, 1,  0, 0, 0],
        [0, 0, 0,  0, 1, 1,  0, 0, 0],

        [0, 0, 0,  0, 0, 0,  0, 0, 0],
        [0, 0, 0,  0, 0, 0,  0, 0, 0],
        [0, 0, 0,  0, 0, 0,  0, 0, 0]
    ])

    shapes= grid.makeRectangles(0, 0.31)

    scene.fromShapes(shapes, 0)
    scene.connectAllClose( 0.021 )

    tll.artist.drawScene(scene)
    
    assert len(shapes) == 11
    referes= [
        [(0.01, 0.01), (0.01, 0.29), (0.29, 0.29), (0.29, 0.01)],
        [(0.31, 0.01), (0.31, 0.29), (0.59, 0.29), (0.59, 0.01)],
        [(0.61, 0.01), (0.61, 0.29), (0.89, 0.29), (0.89, 0.01)],
        
        [(0.01, 0.31), (0.01, 0.59), (0.29, 0.59), (0.29, 0.31)],
        [(0.31, 0.31), (0.31, 0.59), (0.39, 0.59), (0.39, 0.31)],
        [(0.61, 0.31), (0.61, 0.59), (0.89, 0.59), (0.89, 0.31)],
        
        [(0.11, 0.61), (0.11, 0.69), (0.39, 0.69), (0.39, 0.61)],
        [(0.41, 0.61), (0.41, 0.89), (0.69, 0.89), (0.69, 0.61)],
        [(0.71, 0.61), (0.71, 0.89), (0.89, 0.89), (0.89, 0.61)],
        
        [(0.21, 0.71), (0.21, 0.79), (0.39, 0.79), (0.39, 0.71)],
        [(0.31, 0.81), (0.31, 0.89), (0.39, 0.89), (0.39, 0.81)]
    ]

    print( '-'*10 )
    for shape, ref  in zip( shapes, referes ) :
        print( shape.round(2).asZipped() )
        assert shape.asZipped() ==  ref

    assert scene.selectId(lambda t : t.matter() == 0) == [i for i in range(1, 12)]
    assert scene.selectIdSmallbox(0.16) == [5, 7, 10, 11]

    assert( scene.mergeTile(5, 0.06, 1.0) )
    #tll.artist.drawScene(scene, "shot-1.png")
    body4= scene.tile(4).body().round(2).asZipped()
    print( body4 )
    assert body4 ==  [(0.01, 0.31), (0.01, 0.59), (0.39, 0.59), (0.39, 0.31)]
    
    assert( scene.mergeTile(6, 0.06, 1.0) )
    #tll.artist.drawScene(scene, "shot-2.png")
    body6= scene.tile(6).body().round(2).asZipped()
    print(body6)
    assert body6 ==  [(0.11, 0.61), (0.11, 0.69), (0.21, 0.79), (0.39, 0.79), (0.39, 0.61)]
    scene.mergeAllPossible( 0.06, 0.31 )

    for t in scene.tiles() :
        t.position().round(2)
        t.shape().round(2)
    tll.artist.drawScene(scene)

    print( f"---\n{scene.asPod()}." )
    assert "\n"+ str(scene.asPod()) +"\n" == """
Scene: [0.01]
- Tile: [1, 0, 2, 4] [0.15, 0.15]
  - Convex: [-0.14, -0.14, -0.14, 0.14, 0.14, 0.14, 0.14, -0.14]
- Tile: [2, 0, 1, 3, 4] [0.45, 0.15]
  - Convex: [-0.14, -0.14, -0.14, 0.14, 0.14, 0.14, 0.14, -0.14]
- Tile: [3, 0, 2, 5] [0.75, 0.15]
  - Convex: [-0.14, -0.14, -0.14, 0.14, 0.14, 0.14, 0.14, -0.14]
- Tile: [4, 0, 1, 2, 6] [0.2, 0.45]
  - Convex: [-0.19, -0.14, -0.19, 0.14, 0.19, 0.14, 0.19, -0.14]
- Tile: [5, 0, 3, 7, 8] [0.75, 0.45]
  - Convex: [-0.14, -0.14, -0.14, 0.14, 0.14, 0.14, 0.14, -0.14]
- Tile: [6, 0, 4, 7] [0.25, 0.75]
  - Convex: [-0.14, -0.14, -0.14, -0.06, 0.06, 0.14, 0.14, 0.14, 0.14, -0.14]
- Tile: [7, 0, 5, 6, 8] [0.55, 0.75]
  - Convex: [-0.14, -0.14, -0.14, 0.14, 0.14, 0.14, 0.14, -0.14]
- Tile: [8, 0, 5, 7] [0.8, 0.75]
  - Convex: [-0.09, -0.14, -0.09, 0.14, 0.09, 0.14, 0.09, -0.14]
"""

def test_makeConvexes_small():
    grid= tll.Grid([
        [0, 0, 0, 0, 1,  1, 1, 1, 1, 1,  1, 1, 1, 1, 1,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1 ],
        [0, 0, 0, 0, 0,  1, 1, 0, 0, 0,  1, 1, 1, 1, 1,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1 ],
        [1, 0, 0, 0, 0,  1, 1, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1 ],
        [1, 1, 0, 0, 0,  1, 1, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 1, 1, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 1, 1, 1, 1 ],
        [1, 0, 0, 0, 0,  1, 1, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 1, 1, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 1, 1, 1, 1 ],

        [0, 0, 0, 0, 0,  0, 1, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 1, 1 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 1, 1 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 1, 1, 1, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 0, 0,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],

        [1, 0, 0, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 1, 1, 1, 1,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 1, 1, 1,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [1, 1, 1, 1, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [1, 1, 0, 0, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 1, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],

        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1, 0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 1, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 1, 1, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0 ],

        [0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  1, 1, 0, 0, 0,  0, 0, 0, 0, 1,  0, 0, 0, 0, 0,  0, 0, 1, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  1, 1, 0, 0, 0,  0, 0, 0, 0, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 1,  1, 1, 1, 1, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],

        [0, 0, 0, 0, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ],
        [0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 1,  1, 0, 0, 0, 0,  0, 0, 0, 0, 0,  0, 0, 0, 0, 0 ]
    ], tll.Point(0.5, 0.5), 1.0 )
    grid.filter(1, -1)
    
    scene= tll.Scene().fromGridConvexes(grid, 8.0)

    tll.artist.drawScene( scene )

    print('\n'+'\n'.join( [str(c) for c in scene.convexes() ])+'.')
    assert '\n'+'\n'.join( [str(c) for c in scene.convexes() ]) == """
    Convex 6[(1.5, 1.5), (9.5, 10.5)]
    Convex 8[(10.5, 1.5), (19.5, 11.5)]
    Convex 8[(21.5, 1.5), (28.5, 10.5)]
    Convex 5[(29.5, 1.5), (35.5, 9.5)]
    Convex 8[(1.5, 10.5), (13.5, 19.5)]
    Convex 11[(14.5, 8.5), (25.5, 18.5)]
    Convex 6[(27.5, 10.5), (35.5, 17.5)]
    Convex 8[(1.5, 20.5), (8.5, 30.5)]
    Convex 11[(9.5, 13.5), (18.5, 23.5)]
    Convex 5[(24.5, 16.5), (29.5, 24.5)]
    Convex 6[(30.5, 18.5), (35.5, 25.5)]
    Convex 9[(8.5, 22.5), (16.5, 29.5)]
    Convex 10[(17.5, 21.5), (24.5, 30.5)]
    Convex 6[(23.5, 25.5), (30.5, 30.5)]"""

    assert False
